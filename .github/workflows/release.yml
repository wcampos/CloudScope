# Release: (1) Release Please runs on push to main → creates/updates release PR (see CHANGELOG.md there).
#          (2) When that release PR is merged to main, Release Please publishes the release → release published event.
#          (3) release-assets job runs on release published → creates zip (excludes .cursor) and uploads as artifact.
name: Release

on:
  push:
    branches: [main]
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Release Please
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          release-type: python
          changelog-types: '{"feat":"Features","fix":"Bug Fixes","docs":"Documentation","style":"Styles","refactor":"Code Refactoring","perf":"Performance Improvements","test":"Tests","build":"Build System","ci":"CI"}'

  release-assets:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Create release zip
        id: zip
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          ZIP_NAME="cloudscope_${VERSION}.zip"
          zip -r "${ZIP_NAME}" . \
            -x "*.git*" \
            -x "*__pycache__*" \
            -x "*.pytest_cache*" \
            -x "*.env*" \
            -x "*.coverage*" \
            -x "*htmlcov*" \
            -x "*node_modules*" \
            -x "*.vscode*" \
            -x "*.idea*" \
            -x "*venv*" \
            -x "*.venv*" \
            -x "*logs*" \
            -x "*.db" \
            -x "*.sqlite3" \
            -x ".cursor/*" \
            -x ".cursor*" \
            -x ".cursorrules"
          echo "zip_name=${ZIP_NAME}" >> $GITHUB_OUTPUT

      - name: Upload zip to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPLOAD_URL: ${{ github.event.release.upload_url }}
          ZIP_NAME: ${{ steps.zip.outputs.zip_name }}
        run: |
          UPLOAD_URL="${UPLOAD_URL%\{*}"
          curl -sS -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/zip" \
            --data-binary @"$ZIP_NAME" \
            "$UPLOAD_URL?name=$ZIP_NAME"
